#!/bin/sh
set -eux
VERSION=$1

# Determine the platform explicitly or via convention
case ${VERSION} in
  *-jetty ) PLATFORM=jetty;;
  * ) PLATFORM=java;;
esac

# Build the code and copy the results into the installation root
cd ${VERSION}
/code/build-bin/maven/maven_build
/code/docker/bin/install-${PLATFORM}-example
mv install /install

cd /install/bin

# Generate ENTRYPOINT scripts used in the Dockerfile
cat > start-frontend <<-'EOF'
#!/bin/sh
BRAVE_SERVICE=frontend
PORT=8081
EXAMPLE_OPTS="-Dbackend.endpoint=http://backend:9000/api"
EOF

cat > start-backend <<-'EOF'
#!/bin/sh
BRAVE_SERVICE=backend
PORT=9000
EOF

tee -a start-frontend start-backend <<-'EOF'
IP="$(hostname -i || echo '127.0.0.1')"
ZIPKIN_BASEURL=${ZIPKIN_BASEURL:-http://zipkin:9411}
BRAVE_SUPPORTS_JOIN=${BRAVE_SUPPORTS_JOIN:-true}
BRAVE_TRACEID_128=${BRAVE_TRACEID_128:-false}
EOF

# Add common elements for web apps
tee -a start-frontend start-backend <<-'EOF'

# write the docker-healthcheck url to a file
echo http://${IP}:${PORT}/health > health_url

EXAMPLE_OPTS="\
-Dbrave.localServiceName=${BRAVE_SERVICE} \
-Dbrave.supportsJoin=${BRAVE_SUPPORTS_JOIN} \
-Dbrave.traceId128Bit=${BRAVE_TRACEID_128} \
-Dbrave.zipkin.baseUrl=${ZIPKIN_BASEURL}"
EOF

cat /code/docker/bin/start-${PLATFORM}-example | tee -a start-frontend start-backend
sed -i 's/Frontend/Backend/' start-backend
chmod 755 start-frontend start-backend

# Add HEALTHCHECK script used in the Dockerfile
cp -p /code/docker/bin/docker-healthcheck .

# Make any platform-specific revisions
if [ "${VERSION}" = "ratpack" ]; then
  sed -i 's/-D/-Dratpack./g' start-frontend start-backend
fi
